generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum UserRole {
  ADMIN
  MANAGER
  LEAD
  EMPLOYEE
}

enum ProjectStatus {
  ON_TRACK
  AT_RISK
  DELAYED
  COMPLETED
  ON_HOLD
}

enum AppraisalStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PTOStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum PTOType {
  VACATION
  SICK_LEAVE
  PERSONAL
  UNPAID
  BEREAVEMENT
  PARENTAL
}

enum TimesheetStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  NEEDS_CORRECTION
}

enum AuditAction {
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_DEACTIVATED
  ROLE_CHANGED
  APPRAISAL_CREATED
  APPRAISAL_UPDATED
  APPRAISAL_COMPLETED
  DATA_EXPORTED
  INTEGRATION_ENABLED
  INTEGRATION_DISABLED
  SETTINGS_UPDATED
}

model User {
  id                  String               @id @default(cuid())
  email               String               @unique
  password            String?
  firstName           String?
  lastName            String?
  name                String?
  image               String?
  emailVerified       DateTime?
  role                UserRole             @default(EMPLOYEE)
  departmentId        String?
  teamId              String?
  managerId           String?
  position            String?
  phoneNumber         String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  lastLogin           DateTime?
  lastLoginIp         String?
  lastLoginUserAgent  String?
  status              UserStatus           @default(ACTIVE)
  preferences         Json?                @default("{\"theme\":\"light\",\"language\":\"English\",\"timezone\":\"UTC\"}")
  notificationSettings Json?               @default("{\"emailNotifications\":true,\"projectUpdates\":true,\"teamActivity\":true,\"loginAlerts\":true}")

  accounts            Account[]
  sessions            Session[]
  department          Department?          @relation(fields: [departmentId], references: [id])
  team                Team?                @relation(fields: [teamId], references: [id])
  manager             User?                @relation("ManagerEmployee", fields: [managerId], references: [id])
  employees           User[]               @relation("ManagerEmployee")
  ownedProjects       Project[]            @relation("ProjectOwner")
  projectMembers      ProjectMember[]
  appraisalReviews    AppraisalReview[]
  performanceMetrics  PerformanceMetric[]
  auditLogs           AuditLog[]
  customRoles         UserCustomRole[]
  ptoRequests         PTORequest[]
  timesheets          Timesheet[]
  approvedPTOs        PTORequest[]         @relation("PTOApprover")
  approvedTimesheets  Timesheet[]          @relation("TimesheetApprover")

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("password_reset_tokens")
}

model Department {
  id          String   @id @default(cuid())
  name        String
  description String?
  headId      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  teams       Team[]

  @@map("departments")
}

model Team {
  id           String     @id @default(cuid())
  name         String
  description  String?
  departmentId String
  leadId       String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  users        User[]
  projects     Project[]

  @@map("teams")
}

model Project {
  id               String        @id @default(cuid())
  name             String
  description      String?
  status           ProjectStatus @default(ON_TRACK)
  ownerId          String
  teamId           String?
  startDate        DateTime?
  endDate          DateTime?
  completionRate   Float         @default(0)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  owner            User          @relation("ProjectOwner", fields: [ownerId], references: [id])
  team             Team?         @relation(fields: [teamId], references: [id])
  members          ProjectMember[]
  performanceMetrics PerformanceMetric[]
  timesheetEntries TimesheetEntry[]
  tasks            Task[]

  @@map("projects")
}

model ProjectMember {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  role      String?
  joinedAt  DateTime @default(now())

  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_members")
}

model PerformanceMetric {
  id              String   @id @default(cuid())
  userId          String
  projectId       String?
  metric          String
  value           Float
  period          String
  recordedAt      DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project         Project? @relation(fields: [projectId], references: [id])

  @@map("performance_metrics")
}

model AppraisalCycle {
  id          String          @id @default(cuid())
  name        String
  description String?
  startDate   DateTime
  endDate     DateTime
  status      AppraisalStatus @default(DRAFT)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  reviews     AppraisalReview[]

  @@map("appraisal_cycles")
}

model AppraisalReview {
  id              String          @id @default(cuid())
  cycleId         String
  userId          String
  selfReview      String?
  managerReview   String?
  rating          Float?
  finalRating     Float?
  status          AppraisalStatus @default(DRAFT)
  submittedAt     DateTime?
  completedAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  cycle           AppraisalCycle  @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([cycleId, userId])
  @@map("appraisal_reviews")
}

model AuditLog {
  id          String      @id @default(cuid())
  userId      String?
  action      AuditAction
  entity      String
  entityId    String?
  details     String?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())

  user        User?       @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

model Integration {
  id          String   @id @default(cuid())
  name        String   @unique
  type        String
  enabled     Boolean  @default(false)
  config      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("integrations")
}

model CustomRole {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  permissions String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       UserCustomRole[]

  @@map("custom_roles")
}

model UserCustomRole {
  id           String     @id @default(cuid())
  userId       String
  customRoleId String
  assignedAt   DateTime   @default(now())

  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  customRole   CustomRole @relation(fields: [customRoleId], references: [id], onDelete: Cascade)

  @@unique([userId, customRoleId])
  @@map("user_custom_roles")
}

model OrganizationSettings {
  id              String   @id @default(cuid())
  timeZone        String   @default("UTC")
  workWeek        String   @default("Mon-Fri")
  workHoursStart  String   @default("09:00")
  workHoursEnd    String   @default("17:00")
  holidays        String?
  aiEnabled       Boolean  @default(true)
  aiThreshold     Float    @default(0.7)
  updatedAt       DateTime @updatedAt

  @@map("organization_settings")
}

model PTORequest {
  id          String     @id @default(cuid())
  userId      String
  type        PTOType
  startDate   DateTime
  endDate     DateTime
  days        Float
  reason      String?
  status      PTOStatus  @default(PENDING)
  approverId  String?
  approvedAt  DateTime?
  rejectionReason String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  approver    User?      @relation("PTOApprover", fields: [approverId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([startDate])
  @@map("pto_requests")
}

model Timesheet {
  id          String          @id @default(cuid())
  userId      String
  weekStart   DateTime
  weekEnd     DateTime
  totalHours  Float           @default(0)
  status      TimesheetStatus @default(DRAFT)
  approverId  String?
  approvedAt  DateTime?
  comments    String?
  entries     TimesheetEntry[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  approver    User?           @relation("TimesheetApprover", fields: [approverId], references: [id])

  @@unique([userId, weekStart])
  @@index([userId])
  @@index([status])
  @@index([weekStart])
  @@map("timesheets")
}

model TimesheetEntry {
  id          String     @id @default(cuid())
  timesheetId String
  date        DateTime
  projectId   String?
  hours       Float
  description String?
  billable    Boolean    @default(false)
  createdAt   DateTime   @default(now())

  timesheet   Timesheet  @relation(fields: [timesheetId], references: [id], onDelete: Cascade)
  project     Project?   @relation(fields: [projectId], references: [id])

  @@index([timesheetId])
  @@index([date])
  @@map("timesheet_entries")
}

model Goal {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String?
  targetDate  DateTime?
  progress    Float    @default(0)
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@map("goals")
}

model OneOnOne {
  id          String   @id @default(cuid())
  managerId   String
  employeeId  String
  scheduledAt DateTime
  duration    Int      @default(30)
  notes       String?
  topics      String?
  actionItems String?
  completed   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([managerId])
  @@index([employeeId])
  @@index([scheduledAt])
  @@map("one_on_ones")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  BLOCKED
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SprintStatus {
  PLANNING
  ACTIVE
  COMPLETED
  CANCELLED
}

model Task {
  id              String       @id @default(cuid())
  title           String
  description     String?
  status          TaskStatus   @default(TODO)
  priority        TaskPriority @default(MEDIUM)
  projectId       String?
  assigneeId      String?
  reporterId      String
  sprintId        String?
  storyPoints     Int?
  estimatedHours  Float?
  actualHours     Float?
  blockedReason   String?
  dependencies    String?      // JSON array of task IDs
  tags            String?      // JSON array of tags
  acceptanceCriteria String?
  technicalNotes  String?
  prUrl           String?
  startedAt       DateTime?
  completedAt     DateTime?
  dueDate         DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  project         Project?     @relation(fields: [projectId], references: [id])
  sprint          Sprint?      @relation(fields: [sprintId], references: [id])

  @@index([projectId])
  @@index([assigneeId])
  @@index([sprintId])
  @@index([status])
  @@map("tasks")
}

model Sprint {
  id          String        @id @default(cuid())
  name        String
  goal        String?
  teamId      String?
  startDate   DateTime
  endDate     DateTime
  status      SprintStatus  @default(PLANNING)
  velocity    Int?
  capacityHours Float?
  retrospectiveNotes String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  tasks       Task[]

  @@index([teamId])
  @@index([status])
  @@index([startDate])
  @@map("sprints")
}

model TechnicalMetric {
  id              String   @id @default(cuid())
  teamId          String?
  projectId       String?
  metricType      String   // pr_merge_time, code_review_time, build_time, deployment_frequency, bug_count, etc.
  value           Float
  unit            String?  // hours, count, percentage, etc.
  period          String   // daily, weekly, sprint
  periodStart     DateTime
  periodEnd       DateTime
  metadata        Json?    // Additional context
  recordedAt      DateTime @default(now())

  @@index([teamId])
  @@index([projectId])
  @@index([metricType])
  @@index([periodStart])
  @@map("technical_metrics")
}

model CodeReview {
  id          String   @id @default(cuid())
  taskId      String?
  prUrl       String
  prTitle     String
  authorId    String
  reviewerId  String?
  status      String   // pending, approved, changes_requested, merged
  linesChanged Int?
  filesChanged Int?
  comments    Int?
  createdAt   DateTime @default(now())
  reviewedAt  DateTime?
  mergedAt    DateTime?

  @@index([authorId])
  @@index([reviewerId])
  @@index([status])
  @@map("code_reviews")
}
